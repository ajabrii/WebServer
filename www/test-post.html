<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POST Method Testing - WebServ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #e4e6ea;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 0;
        }

        .left-panel {
            width: 50%;
            padding: 2rem;
            overflow-y: auto;
            border-right: 1px solid #2d3748;
        }

        .right-panel {
            width: 50%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f59e0b;
        }

        .header h1 {
            font-size: 2rem;
            color: #f9fafb;
            margin-bottom: 0.5rem;
        }

        .nav-back {
            display: inline-block;
            margin-bottom: 1rem;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .nav-back:hover {
            color: #f59e0b;
        }

        .section {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.5);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            color: #f9fafb;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 8px;
            background: rgba(17, 24, 39, 0.6);
            color: #f9fafb;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: #9ca3af;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .test-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            font-size: 0.9rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .test-button:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .test-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .file-input {
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
            backdrop-filter: blur(5px);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 0.8rem;
        }

        .results-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h2 {
            color: #f9fafb;
            font-size: 1.3rem;
        }

        .clear-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }

        .result-area {
            background: rgba(17, 24, 39, 0.8);
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-y: auto;
            flex: 1;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(5px);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .test-item {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .test-item h4 {
            color: #f9fafb;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .upload-zone {
            border: 2px dashed rgba(245, 158, 11, 0.5);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(17, 24, 39, 0.6);
            color: #f9fafb;
            backdrop-filter: blur(5px);
        }

        .upload-zone:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .upload-zone.dragover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .status-200 { color: #10b981; }
        .status-201 { color: #10b981; }
        .status-400 { color: #f59e0b; }
        .status-404 { color: #ef4444; }
        .status-405 { color: #ef4444; }
        .status-500 { color: #ef4444; }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .left-panel, .right-panel {
                width: 100%;
                padding: 1rem;
            }
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <a href="index.html" class="nav-back">‚Üê Back to Home</a>
            
            <div class="header">
                <h1>üì§ POST Method Testing</h1>
                <p>Test file uploads, form data submission, and POST functionality</p>
            </div>

        <!-- File Upload -->
        <div class="section">
            <h2>File Upload (multipart/form-data)</h2>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <p>üìÅ Click or drag files here to upload</p>
                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Max size: 1MB</p>
            </div>
            <input type="file" id="fileInput" style="display: none;" multiple>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <button class="test-button" onclick="uploadFiles()">Upload Selected Files</button>
            <div id="selectedFiles" style="margin-top: 1rem; font-size: 0.9rem; color: #666;"></div>
        </div>

        <!-- Form Data -->
        <div class="section">
            <h2>Form Data (application/x-www-form-urlencoded)</h2>
            <form id="formDataForm" onsubmit="submitFormData(event)">
                <div class="form-group">
                    <label class="form-label">Username:</label>
                    <input type="text" name="username" class="form-input" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label class="form-label">Email:</label>
                    <input type="email" name="email" class="form-input" placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label class="form-label">Message:</label>
                    <textarea name="message" class="form-textarea" placeholder="Enter your message"></textarea>
                </div>
                <button type="submit" class="test-button">Submit Form</button>
            </form>
        </div>

        <!-- JSON Data -->
        <div class="section">
            <h2>JSON Data (application/json)</h2>
            <div class="form-group">
                <label class="form-label">JSON Content:</label>
                <textarea id="jsonInput" class="form-textarea" placeholder='{"key": "value", "number": 42}'>{"username": "testuser", "message": "Hello WebServ!", "timestamp": 1234567890}</textarea>
            </div>
            <button class="test-button" onclick="sendJSON()">Send JSON</button>
            <button class="test-button" onclick="formatJSON()">Format JSON</button>
        </div>

        <!-- Plain Text -->
        <div class="section">
            <h2>Plain Text (text/plain)</h2>
            <div class="form-group">
                <label class="form-label">Text Content:</label>
                <textarea id="textInput" class="form-textarea" placeholder="Enter plain text content">This is a plain text POST request to WebServ server.</textarea>
            </div>
            <button class="test-button" onclick="sendText()">Send Text</button>
        </div>

        <!-- Test Cases -->
        <div class="section">
            <h2>Special Test Cases</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h4>Large Data</h4>
                    <button class="test-button" onclick="testLargeData()">Test 1MB</button>
                    <button class="test-button" onclick="testOversizeData()">Test 2MB</button>
                </div>
                <div class="test-item">
                    <h4>Empty Data</h4>
                    <button class="test-button" onclick="testEmptyPost()">Empty POST</button>
                    <button class="test-button" onclick="testNoContentType()">No Content-Type</button>
                </div>
                <div class="test-item">
                    <h4>Special Characters</h4>
                    <button class="test-button" onclick="testUnicodeData()">Unicode Data</button>
                    <button class="test-button" onclick="testBinaryData()">Binary Data</button>
                </div>
                <div class="test-item">
                    <h4>Multiple Files</h4>
                    <button class="test-button" onclick="testMultipleFiles()">Create & Upload</button>
                    <button class="test-button" onclick="testConcurrentUploads()">Concurrent</button>
                </div>
            </div>
        </div>
        </div>

        <div class="right-panel">
            <!-- Results -->
            <div class="section results-section">
                <div class="results-header">
                    <h2>Test Results</h2>
                    <button class="clear-button" onclick="clearResults()">üóëÔ∏è Clear Results</button>
                </div>
                <div id="results" class="result-area">Ready to test POST requests...\nClick any test button above to see results here.</div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];

        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            const results = document.getElementById('results');
            results.textContent = 'Results cleared.\nReady to test POST requests...';
            log('--- Results cleared ---');
        }

        // File Upload Handling
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateSelectedFiles();
            log(`Selected ${files.length} file(s) for upload`);
        }

        function updateSelectedFiles() {
            const container = document.getElementById('selectedFiles');
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const fileList = selectedFiles.map(file => 
                `${file.name} (${formatFileSize(file.size)})`
            ).join(', ');
            container.innerHTML = `Selected: ${fileList}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                log('No files selected');
                return;
            }

            const formData = new FormData();
            selectedFiles.forEach((file, index) => {
                formData.append(`file${index}`, file);
            });

            log(`Uploading ${selectedFiles.length} file(s) to /uploads/`);
            
            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        const progressFill = document.getElementById('progressFill');
                        progressFill.style.width = percent + '%';
                        progressFill.textContent = percent + '%';
                    }
                };

                xhr.onload = () => {
                    const progressFill = document.getElementById('progressFill');
                    progressFill.style.width = '100%';
                    progressFill.textContent = '100%';
                    
                    log(`Upload completed: ${xhr.status} ${xhr.statusText}`);
                    log(`Response: ${xhr.responseText}`);
                    
                    // Show response in new tab
                    const mockResponse = {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        ok: xhr.status >= 200 && xhr.status < 300,
                        headers: new Map([
                            ['content-type', xhr.getResponseHeader('content-type') || 'text/plain'],
                            ['content-length', xhr.getResponseHeader('content-length') || '0']
                        ]),
                        type: 'basic',
                        redirected: false
                    };
                    showResponseInNewTab('POST (Upload)', '/uploads/', mockResponse, xhr.responseText);
                    
                    setTimeout(() => {
                        progressFill.style.width = '0%';
                        progressFill.textContent = '0%';
                    }, 2000);
                };

                xhr.onerror = () => {
                    log('Upload failed: Network error');
                };

                xhr.open('POST', '/uploads/');
                xhr.send(formData);
                
            } catch (error) {
                log(`Upload error: ${error.message}`);
            }
        }

        async function submitFormData(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Convert FormData to URL-encoded string
            const urlEncodedData = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                urlEncodedData.append(key, value);
            }
            
            log('Submitting form data to /uploads/');
            log(`Form data: ${urlEncodedData.toString()}`);
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: urlEncodedData.toString()
                });
                
                log(`Response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                log(`Response body: ${responseText}`);
                
                // Show response in new tab
                showResponseInNewTab('POST (Form)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Form submission error: ${error.message}`);
                showErrorInNewTab('POST (Form)', '/uploads/', error);
            }
        }

        async function sendJSON() {
            const jsonInput = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInput) {
                log('Please enter JSON data');
                return;
            }

            try {
                JSON.parse(jsonInput); // Validate JSON
                log('Sending JSON data to /uploads/');
                
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: jsonInput
                });
                
                log(`Response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                log(`Response body: ${responseText}`);
                
                // Show response in new tab
                showResponseInNewTab('POST (JSON)', '/uploads/', response, responseText);
                
            } catch (error) {
                if (error instanceof SyntaxError) {
                    log(`Invalid JSON: ${error.message}`);
                } else {
                    log(`JSON POST error: ${error.message}`);
                    showErrorInNewTab('POST (JSON)', '/uploads/', error);
                }
            }
        }

        async function sendText() {
            const textInput = document.getElementById('textInput').value;
            
            if (!textInput.trim()) {
                log('Please enter text content');
                return;
            }

            log('Sending plain text to /uploads/');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: textInput
                });
                
                log(`Response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                log(`Response body: ${responseText}`);
                
                // Show response in new tab
                showResponseInNewTab('POST (Text)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Text POST error: ${error.message}`);
                showErrorInNewTab('POST (Text)', '/uploads/', error);
            }
        }

        function formatJSON() {
            const jsonInput = document.getElementById('jsonInput');
            try {
                const parsed = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(parsed, null, 2);
                log('JSON formatted successfully');
            } catch (error) {
                log(`JSON format error: ${error.message}`);
            }
        }

        // Test Cases
        async function testLargeData() {
            const largeData = 'A'.repeat(1024 * 1024); // 1MB
            log('Testing 1MB POST request...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: largeData
                });
                
                log(`Large data response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (Large Data)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Large data error: ${error.message}`);
                showErrorInNewTab('POST (Large Data)', '/uploads/', error);
            }
        }

        async function testOversizeData() {
            const oversizeData = 'B'.repeat(2 * 1024 * 1024); // 2MB
            log('Testing 2MB POST request (should exceed limit)...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: oversizeData
                });
                
                log(`Oversize data response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (Oversize)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Oversize data error: ${error.message}`);
                showErrorInNewTab('POST (Oversize)', '/uploads/', error);
            }
        }

        async function testEmptyPost() {
            log('Testing empty POST request...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    body: ''
                });
                
                log(`Empty POST response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (Empty)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Empty POST error: ${error.message}`);
                showErrorInNewTab('POST (Empty)', '/uploads/', error);
            }
        }

        async function testNoContentType() {
            log('Testing POST without Content-Type header...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    body: 'Test data without content type'
                });
                
                log(`No Content-Type response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (No Content-Type)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`No Content-Type error: ${error.message}`);
                showErrorInNewTab('POST (No Content-Type)', '/uploads/', error);
            }
        }

        async function testUnicodeData() {
            const unicodeData = '{"message": "Hello ‰∏ñÁïå! üåç √ëo√´l Caf√©"}';
            log('Testing Unicode data...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: unicodeData
                });
                
                log(`Unicode data response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (Unicode)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Unicode data error: ${error.message}`);
                showErrorInNewTab('POST (Unicode)', '/uploads/', error);
            }
        }

        async function testBinaryData() {
            const binaryData = new Uint8Array([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);
            log('Testing binary data...');
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: binaryData
                });
                
                log(`Binary data response: ${response.status} ${response.statusText}`);
                const responseText = await response.clone().text();
                
                // Show response in new tab
                showResponseInNewTab('POST (Binary)', '/uploads/', response, responseText);
                
            } catch (error) {
                log(`Binary data error: ${error.message}`);
                showErrorInNewTab('POST (Binary)', '/uploads/', error);
            }
        }

        async function testMultipleFiles() {
            log('Creating multiple test files and uploading...');
            
            const files = [
                new File(['Test file 1 content'], 'test1.txt', { type: 'text/plain' }),
                new File(['Test file 2 content'], 'test2.txt', { type: 'text/plain' }),
                new File(['{"test": "json"}'], 'test.json', { type: 'application/json' })
            ];
            
            const formData = new FormData();
            files.forEach((file, index) => {
                formData.append(`testfile${index}`, file);
            });
            
            try {
                const response = await fetch('/uploads/', {
                    method: 'POST',
                    body: formData
                });
                log(`Multiple files response: ${response.status} ${response.statusText}`);
            } catch (error) {
                log(`Multiple files error: ${error.message}`);
            }
        }

        async function testConcurrentUploads() {
            log('Testing concurrent uploads...');
            
            const promises = [];
            for (let i = 0; i < 3; i++) {
                const formData = new FormData();
                formData.append('file', new File([`Concurrent file ${i}`], `concurrent${i}.txt`));
                
                promises.push(
                    fetch('/uploads/', {
                        method: 'POST',
                        body: formData
                    })
                );
            }
            
            try {
                const responses = await Promise.all(promises);
                responses.forEach((response, index) => {
                    log(`Concurrent upload ${index}: ${response.status} ${response.statusText}`);
                });
            } catch (error) {
                log(`Concurrent uploads error: ${error.message}`);
            }
        }

        // Function to show server response in new tab
        function showResponseInNewTab(method, url, response, responseText) {
            const newTab = window.open('about:blank', '_blank');
            if (!newTab) {
                log('Popup blocked - unable to open response in new tab');
                return;
            }
            
            // Check if the response is HTML content that should be rendered  
            const isHtmlContent = (text) => {
                const content = (text || '').trim().toLowerCase();
                return content.includes('<!doctype html') || 
                       content.includes('<html') || 
                       content.includes('<head>') || 
                       content.includes('<body>') ||
                       (content.includes('<') && content.includes('>') && (content.includes('<h1') || content.includes('<h2') || content.includes('<p>') || content.includes('<div')));
            };
            
            // If it's an error response (status >= 400) and contains HTML, render it directly
            if (response.status >= 400 && isHtmlContent(responseText)) {
                newTab.document.write(responseText || '(empty response)');
                newTab.document.close();
                return;
            }
            
            const timestamp = new Date().toISOString();
            const headers = [];
            
            if (response.headers && response.headers.entries) {
                for (const [key, value] of response.headers.entries()) {
                    headers.push(`${key}: ${value}`);
                }
            } else if (response.headers && response.headers.forEach) {
                response.headers.forEach((value, key) => {
                    headers.push(`${key}: ${value}`);
                });
            }
            
            // Escape HTML in response text to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Check if the response is HTML content that should be rendered
            const isHtmlResponse = (text) => {
                const content = (text || '').trim().toLowerCase();
                return content.includes('<!doctype html') || 
                       content.includes('<html') || 
                       content.includes('<head>') || 
                       content.includes('<body>') ||
                       (content.includes('<') && content.includes('>') && (content.includes('<h1') || content.includes('<h2') || content.includes('<p>') || content.includes('<div')));
            };
            
            const processedResponseText = isHtmlResponse(responseText) ? (responseText || '(empty response)') : escapeHtml(responseText || '(empty response)');
            const statusClass = response.ok ? 'success' : (response.status >= 400 ? 'error' : 'warning');
            const statusIcon = response.ok ? '‚úÖ' : (response.status >= 400 ? '‚ùå' : '‚ö†Ô∏è');
            
            const html = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${method} Response - ${response.status}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                            margin: 0; 
                            padding: 20px;
                            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
                            color: #e4e6ea;
                            min-height: 100vh;
                            line-height: 1.6;
                        }
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        .header { 
                            background: rgba(31, 41, 55, 0.9);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(245, 158, 11, 0.5);
                            color: #f9fafb; 
                            padding: 25px; 
                            border-radius: 12px; 
                            margin-bottom: 25px;
                            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.3);
                        }
                        .status-line { 
                            font-size: 1.8em; 
                            margin-bottom: 15px; 
                            color: #fbbf24; 
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .header-info {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 15px;
                            margin-top: 15px;
                        }
                        .info-item {
                            background: rgba(17, 24, 39, 0.6);
                            padding: 10px 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(75, 85, 99, 0.3);
                        }
                        .info-label {
                            font-weight: 600;
                            color: #9ca3af;
                            font-size: 0.9em;
                        }
                        .info-value {
                            color: #f9fafb;
                            font-family: 'Courier New', monospace;
                        }
                        .section { 
                            background: rgba(31, 41, 55, 0.9);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(75, 85, 99, 0.5);
                            padding: 20px; 
                            margin-bottom: 20px; 
                            border-radius: 12px; 
                            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                        }
                        .section h3 { 
                            margin-top: 0; 
                            margin-bottom: 15px;
                            color: #f9fafb; 
                            font-weight: 600;
                            font-size: 1.2em;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .response-body { 
                            background: rgba(17, 24, 39, 0.9);
                            color: #e5e7eb; 
                            padding: 20px; 
                            border-radius: 8px; 
                            white-space: pre-wrap; 
                            overflow-x: auto; 
                            max-height: 500px; 
                            overflow-y: auto;
                            border: 1px solid rgba(75, 85, 99, 0.5);
                            font-family: 'Courier New', monospace;
                            font-size: 0.9em;
                            word-break: break-all;
                        }
                        .response-body.html-content {
                            background: rgba(31, 41, 55, 0.9);
                            color: #e4e6ea;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            white-space: normal;
                            word-break: normal;
                        }
                        .headers-list {
                            background: rgba(17, 24, 39, 0.6);
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(75, 85, 99, 0.3);
                            font-family: 'Courier New', monospace;
                            font-size: 0.9em;
                        }
                        .header-item {
                            margin-bottom: 8px;
                            padding: 5px 0;
                            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
                        }
                        .header-item:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .success { 
                            border-left: 4px solid #10b981; 
                            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
                        }
                        .error { 
                            border-left: 4px solid #ef4444; 
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
                        }
                        .warning { 
                            border-left: 4px solid #f59e0b; 
                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            margin-left: 10px;
                        }
                        .status-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
                        .status-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
                        .status-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
                        .close-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: rgba(239, 68, 68, 0.9);
                            color: white;
                            border: none;
                            padding: 10px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            backdrop-filter: blur(10px);
                            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                            transition: all 0.3s ease;
                        }
                        .close-button:hover {
                            background: rgba(239, 68, 68, 1);
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
                        }
                        @media (max-width: 768px) {
                            body { padding: 10px; }
                            .header-info { grid-template-columns: 1fr; }
                            .section { padding: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <button class="close-button" onclick="window.close()">‚úï Close</button>
                        
                        <div class="header">
                            <div class="status-line">
                                ${statusIcon} POST Request Response
                                <span class="status-badge status-${statusClass}">${response.status}</span>
                            </div>
                            <div class="header-info">
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">${response.status} ${response.statusText}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">URL</div>
                                    <div class="info-value">${url}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Method</div>
                                    <div class="info-value">${method}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Time</div>
                                    <div class="info-value">${timestamp}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section ${statusClass}">
                            <h3>üìã Response Headers</h3>
                            <div class="headers-list">
                                ${headers.length > 0 ? headers.map(header => `<div class="header-item">${header}</div>`).join('') : '<div class="header-item">No headers received</div>'}
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>üìÑ Response Body</h3>
                            <div class="response-body${isHtmlResponse(responseText) ? ' html-content' : ''}">${processedResponseText}</div>
                        </div>
                        
                        <div class="section">
                            <h3>‚ÑπÔ∏è Request Details</h3>
                            <div class="headers-list">
                                <div class="header-item"><strong>Method:</strong> POST</div>
                                <div class="header-item"><strong>URL:</strong> ${url}</div>
                                <div class="header-item"><strong>Success:</strong> ${response.ok ? 'Yes ‚úÖ' : 'No ‚ùå'}</div>
                                <div class="header-item"><strong>Type:</strong> ${response.type || 'N/A'}</div>
                                <div class="header-item"><strong>Redirected:</strong> ${response.redirected ? 'Yes' : 'No'}</div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            newTab.document.write(html);
            newTab.document.close();
        }

        // Function to show error in new tab
        function showErrorInNewTab(method, url, error) {
            const newTab = window.open('about:blank', '_blank');
            if (!newTab) {
                log('Popup blocked - unable to open error in new tab');
                return;
            }
            
            const timestamp = new Date().toISOString();
            
            // Escape HTML in error message to prevent XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            const escapedErrorMessage = escapeHtml(error.message || 'Unknown error occurred');
            
            const html = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${method} Error - Network Issue</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                            margin: 0; 
                            padding: 20px;
                            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
                            color: #e4e6ea;
                            min-height: 100vh;
                            line-height: 1.6;
                        }
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        .header { 
                            background: rgba(31, 41, 55, 0.9);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(239, 68, 68, 0.5);
                            color: #f9fafb; 
                            padding: 25px; 
                            border-radius: 12px; 
                            margin-bottom: 25px;
                            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.3);
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
                        }
                        .error-title { 
                            font-size: 1.8em; 
                            color: #fbbf24; 
                            margin-bottom: 15px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .header-info {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 15px;
                            margin-top: 15px;
                        }
                        .info-item {
                            background: rgba(17, 24, 39, 0.7);
                            padding: 10px 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(239, 68, 68, 0.3);
                        }
                        .info-label {
                            font-weight: 600;
                            color: #9ca3af;
                            font-size: 0.9em;
                        }
                        .info-value {
                            color: #f9fafb;
                            font-family: 'Courier New', monospace;
                        }
                        .section { 
                            background: rgba(31, 41, 55, 0.9);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(75, 85, 99, 0.5);
                            border-left: 4px solid #ef4444;
                            padding: 20px; 
                            margin-bottom: 20px; 
                            border-radius: 12px;
                            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.2);
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
                        }
                        .section h3 { 
                            margin-top: 0; 
                            margin-bottom: 15px;
                            color: #f9fafb; 
                            font-weight: 600;
                            font-size: 1.2em;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        .error-message { 
                            background: rgba(17, 24, 39, 0.9);
                            color: #e4e6ea; 
                            padding: 20px; 
                            border-radius: 8px;
                            border: 1px solid rgba(239, 68, 68, 0.4);
                            font-family: 'Courier New', monospace;
                            font-size: 0.95em;
                            word-break: break-word;
                            white-space: pre-wrap;
                        }
                        .section ul {
                            color: #d1d5db;
                            padding-left: 25px;
                            margin-top: 10px;
                        }
                        .section li {
                            margin-bottom: 8px;
                            padding: 5px 0;
                            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
                        }
                        .section li:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .troubleshooting {
                            background: rgba(17, 24, 39, 0.7);
                            padding: 15px;
                            border-radius: 8px;
                            border: 1px solid rgba(75, 85, 99, 0.3);
                            margin-top: 15px;
                        }
                        .troubleshooting h4 {
                            color: #fbbf24;
                            margin-bottom: 10px;
                            font-size: 1em;
                        }
                        .close-button {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: rgba(239, 68, 68, 0.9);
                            color: white;
                            border: none;
                            padding: 10px 15px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            backdrop-filter: blur(10px);
                            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                            transition: all 0.3s ease;
                        }
                        .close-button:hover {
                            background: rgba(239, 68, 68, 1);
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
                        }
                        .error-badge {
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            background: rgba(239, 68, 68, 0.2);
                            color: #ef4444;
                            margin-left: 10px;
                        }
                        @media (max-width: 768px) {
                            body { padding: 10px; }
                            .header-info { grid-template-columns: 1fr; }
                            .section { padding: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <button class="close-button" onclick="window.close()">‚úï Close</button>
                        
                        <div class="header">
                            <div class="error-title">
                                üö® POST Request Error
                                <span class="error-badge">FAILED</span>
                            </div>
                            <div class="header-info">
                                <div class="info-item">
                                    <div class="info-label">URL</div>
                                    <div class="info-value">${url}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Method</div>
                                    <div class="info-value">${method}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Error Type</div>
                                    <div class="info-value">${error.name || 'NetworkError'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Time</div>
                                    <div class="info-value">${timestamp}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>‚ö†Ô∏è Error Details</h3>
                            <div class="error-message">${escapedErrorMessage}</div>
                            
                            <div class="troubleshooting">
                                <h4>üîß Quick Troubleshooting</h4>
                                <p style="color: #d1d5db; font-size: 0.9em;">
                                    This error typically occurs when the browser cannot connect to the server. 
                                    Check if your WebServ server is running and accessible.
                                </p>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>üîç Possible Causes</h3>
                            <ul>
                                <li><strong>Server not running:</strong> The WebServ server might not be started or has crashed</li>
                                <li><strong>Network connectivity:</strong> Check your internet connection or local network</li>
                                <li><strong>Port issues:</strong> Server might be running on a different port than expected</li>
                                <li><strong>CORS restrictions:</strong> Browser blocking cross-origin requests</li>
                                <li><strong>Firewall blocking:</strong> Security software preventing the connection</li>
                                <li><strong>Server overload:</strong> Too many requests causing server timeout</li>
                                <li><strong>Invalid endpoint:</strong> The /uploads/ endpoint may not be configured</li>
                            </ul>
                        </div>
                        
                        <div class="section">
                            <h3>üõ†Ô∏è Recommended Actions</h3>
                            <div class="troubleshooting">
                                <ol style="color: #d1d5db; padding-left: 20px;">
                                    <li style="margin-bottom: 10px;"><strong>Check Server Status:</strong> Verify your WebServ is running and listening on the correct port</li>
                                    <li style="margin-bottom: 10px;"><strong>Test Basic Connectivity:</strong> Try accessing the server directly in browser</li>
                                    <li style="margin-bottom: 10px;"><strong>Review Server Logs:</strong> Check WebServ logs for any error messages</li>
                                    <li style="margin-bottom: 10px;"><strong>Verify Configuration:</strong> Ensure /uploads/ route is properly configured</li>
                                    <li style="margin-bottom: 10px;"><strong>Check Network:</strong> Test with curl or similar tools from command line</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            newTab.document.write(html);
            newTab.document.close();
        }
    </script>
</body>
</html>
